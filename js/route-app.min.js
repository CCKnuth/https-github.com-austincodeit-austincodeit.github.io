var global_pdf={};var global_func={};var activeElement;$(document).ready(function(){var map,directionsService,directionsDisplay,geocoder,addressMarkerArray=[],iconCount=0;var labels='0123456789ABCDEFGHIJKL';var initialize=function(){if(google==null){initialize();}
geocoder=new google.maps.Geocoder();directionsService=new google.maps.DirectionsService;directionsDisplay=new google.maps.DirectionsRenderer({draggable:true});directionsDisplay.addListener('directions_changed',function(){console.log('now hwat?')});var myLatlng=new google.maps.LatLng(30.3344316,-97.6791038);var mapOptions={zoom:14,center:myLatlng,mapTypeId:google.maps.MapTypeId.ROADMAP}
map=new google.maps.Map(document.getElementById('map'),mapOptions);google.maps.event.addDomListener(window,"resize",function(){var center=map.getCenter();google.maps.event.trigger(map,"resize");map.setCenter(center);});}
function addMarker(location,popUpText,sort){var labelObject;if(iconCount==0){labelObject={color:'black',fontSize:'11px',fontWeight:'700',text:'START'};}else{labelObject={color:'black',fontSize:'11px',fontWeight:'700',text:labels[iconCount%labels.length]};}
var newMarker=new google.maps.Marker({position:location,label:labelObject,map:map,draggable:false})
var infowindow=new google.maps.InfoWindow({content:popUpText});newMarker.addListener('click',function(){infowindow.open(map,newMarker);});addressMarkerArray.push(newMarker);if(!$(activeElement).attr('val')){$(activeElement).attr('val',location);}
iconCount=iconCount+1;adjustMapBounds();if(sort){updateMarkerOrder(sort);}}
global_func.placeAddressOnMap=function(address,popUpText,sort){geocoder.geocode({'address':address},function(results,status){if(status==google.maps.GeocoderStatus.OK){addMarker(results[0].geometry.location,popUpText,sort);}else{alert('Geocode was not successful for the following reason: '+status);}});}
var adjustMapBounds=function(){if(addressMarkerArray.length<=1){map.setCenter(addressMarkerArray[0].getPosition());}else{var bounds=new google.maps.LatLngBounds();for(var i=0;i<addressMarkerArray.length;i++){bounds.extend(addressMarkerArray[i].getPosition());}
map.fitBounds(bounds);}}
var extractLATLNG=function(coords){var latitude=Number(coords.split(',')[0].trim().slice(1,coords.length));var longitude=Number(coords.split(',')[1].trim().slice(0,-1));return{lat:latitude,lng:longitude};}
var updateMarkerOrder=function(sort){if(sort){var addressRowSelection=$("#routableAddressRows > tr:not(.placeholder)");for(var i=0;i<addressMarkerArray.length;i++){addressMarkerArray[i].setMap(null);}
addressMarkerArray=[];iconCount=0;addressRowSelection.each(function(elem){var latLngObj=extractLATLNG($(this).children("td#location").attr('val'));var popUpText=$(this).children("td#location").text().trim();addMarker(latLngObj,popUpText)
});}else{for(var i=0;i<addressMarkerArray.length;i++){addressMarkerArray[i].setMap(null);}}}
var removeSpecificMarker=function(rowIndex){iconCount=iconCount-1;addressMarkerArray[rowIndex].setMap(null);addressMarkerArray.splice(rowIndex,1);}
var calculateAndDisplayRoute=function(){updateMarkerOrder(null);addressMarkerArray=[];directionsDisplay.setMap(map);var waypts=[],start='',finish='',caseArray=[],locationArray=[],peopleArray=[];var addressRowSelection=$("#routableAddressRows > tr:not(.placeholder)");var summaryPanel=document.getElementById('directions-panel');summaryPanel.innerHTML='';addressRowSelection.each(function(i){var latLngObj=extractLATLNG($(this).children("td#location").attr('val'));caseArray.push($(this).children("td").eq(2).text());locationArray.push($(this).children("td#location").text().trim());peopleArray.push($(this).children("td").eq(8).text().trim());if(i==0){start=new google.maps.LatLng(latLngObj.lat,latLngObj.lng);}else if(i==(addressRowSelection.length-1)){finish=new google.maps.LatLng(latLngObj.lat,latLngObj.lng);}else{waypts.push({location:new google.maps.LatLng(latLngObj.lat,latLngObj.lng),stopover:true});}});directionsService.route({origin:start,destination:finish,waypoints:waypts,optimizeWaypoints:true,drivingOptions:{departureTime:new Date(Date.now()),trafficModel:'bestguess'},travelMode:'DRIVING'},function(response,status){if(status==='OK'){console.log('driving directions complete!!!!')
console.log(response);directionsDisplay.setDirections(response);var route=response.routes[0];var timeCalc=0,distanceCalc=0;for(var i=0;i<=route.legs.length;i++){var routeSegment=i-1;if(i==0){summaryPanel.innerHTML+='<b>Start: '+locationArray[i]+' | '+caseArray[i]+'</b><br>';summaryPanel.innerHTML+='People: '+peopleArray[i]+'<br><hr><br>';}else{timeCalc+=Number(route.legs[routeSegment].duration.text.replace(/[a-z]+/g,'').trim());distanceCalc+=Number(route.legs[routeSegment].distance.text.replace(/[a-z]+/g,'').trim());summaryPanel.innerHTML+='<b>#'+i+'. '+locationArray[i]+' | '+caseArray[i]+'';summaryPanel.innerHTML+='<span id="routeTripTime"><b>Est. Trip:</b> '+route.legs[routeSegment].duration.text+' | <b>Distance:</b> '+route.legs[routeSegment].distance.text+'</span></b><br>';summaryPanel.innerHTML+='People: '+peopleArray[i]+'<br><hr><br>';}}
summaryPanel.innerHTML+='<b>Trip Time:</b> '+timeCalc+' mins | <b>Trip Distance:</b> '+distanceCalc+' mi';}else{window.alert('Directions request failed due to '+status);summaryPanel.innerHTML='';}});}
global_func.validateRemoveButton=function(){$(".removeAddress").unbind('click').bind('click',function(){var rowIndex=$(this).parents("tr:first")[0].rowIndex;removeSpecificMarker(rowIndex-1);$(this).parent().parent().remove();global_func.adjustRowCount();updateMarkerOrder(map);});}
var addAddressFromInput=function(address){$("#routableAddressRows").append('<tr>'+
'<td class="first"><span id="count"></span>'+
'<button type="button" class="btn btn-sm btn-default removeAddress">'+
'<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>'+
'</button>----</td>'+
'<td class="b">temp</td>'+
'<td class="b">n/a</td>'+
'<td class="c">n/a -('+address+')</td>'+
'<td class="a">----</td>'+
'<td class="a">----</td>'+
'<td class="a">----</td>'+
'<td class="a">----</td>'+
'<td class="c">----</td>'+
'<td class="c" id="location">'+address+'</td>'+
'</tr>');activeElement=$("#routableAddressRows > tr:not(.placeholder):last-child").children("td#location");global_func.validateRemoveButton();global_func.adjustRowCount();global_func.placeAddressOnMap(address,address,false);}
global_func.adjustRowCount=function(){$("#routableAddressRows > tr.placeholder").remove()
var divGroup=$("#routableAddressRows > tr");var arrayLength=$("#routableAddressRows > tr:not(.placeholder) ").length;if(arrayLength>=2){$("#createRoute").prop('disabled',false);$("#createRoute").addClass('btn-primary');$("#createRoute").removeClass('btn-default');}else{$("#createRoute").prop('disabled',true);$("#createRoute").removeClass('btn-primary');$("#createRoute").addClass('btn-default');}
divGroup.each(function(i){if(i==0){$(this).children("td").find("span#count").html('S');}else{$(this).children("td").find("span#count").html(i);}});addPlaceholderRows(arrayLength);}
var addPlaceholderRows=function(rowCount){for(var i=rowCount;i<10;i++){var newRow='<tr class="placeholder">';for(var j=0;j<10;j++){newRow+='<td id="no">&nbsp;</td>';}
newRow+='</tr>';$("#routableAddressRows").append(newRow);newRow='';}}
dragula([document.getElementById("availableAddressRows"),document.getElementById("routableAddressRows")],{copy:function(el,source){return source===document.getElementById("availableAddressRows")},accepts:function(el,target){return target!==document.getElementById("availableAddressRows")},moves:function(el,container,handle){return!el.classList.contains('mobile')},delay:100,removeOnSpill:false}).on('drop',function(el,target,sibling){if(target){if($(el).children("td").children("button").length){updateMarkerOrder(map);}else{$(el).children("td.first").prepend(''+'<span id="count"></span>'+
'<button type="button" class="btn btn-sm btn-default removeAddress">'+
'<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>'+
'</button>');var newAddress=$(el).children("td#location").text().trim()+", Austin, TX";var popUpText=$(el).children("td#location").text().trim();activeElement=$(el).children("td#location");var tableLength=$(target).children("tr:not(.placeholder)").length-1;var dropIndex=$(target).children("tr.gu-transit")[0].rowIndex;var sort=false;if(dropIndex<=tableLength){sort=true;}
global_func.placeAddressOnMap(newAddress,popUpText,sort);}
global_func.validateRemoveButton();global_func.adjustRowCount();}else{console.log('missed');}}).on('drag',function(el){$(el).css('font-size','11px');$(el).css('background-color','white');$(el).css('border','1px #ddd solid');$(el).children().css('width','10%');}).on('remove',function(el){console.log('item removed...');global_func.adjustRowCount();});$("#dropdownChoice > li").on('click',function(){var addressValue=$(this).attr('val');addAddressFromInput(addressValue);});$("#addNewAddress").on('click',function(){if($("#addressInput").val().length>=5){var addressValue=$("#addressInput").val();addAddressFromInput(addressValue);$("#addressInput").val('');}});$(document).keypress(function(e){if(e.which==13&&$("#addressInput:focus").val()){if($("#addressInput:focus").val().length>=5){$("#addNewAddress").trigger("click");}}});$("#createRoute").on('click',function(){$("#loading-overlay").fadeIn("fast");calculateAndDisplayRoute();});$("#resetList").on('click',function(){$("#availableAddressRows").html("");$("#directions-panel").html("");var divGroup=$("#routableAddressRows > tr:not(.placeholder)");divGroup.each(function(i){$(this).remove()});global_func.adjustRowCount();updateMarkerOrder(null);directionsDisplay.setMap(null);addressMarkerArray=[];iconCount=0;$(".header-row th").removeClass("headerSortUp");$(".header-row th").removeClass("headerSortDown");});addPlaceholderRows(0);initialize();$("#availableAddressTable").tablesorter({sortReset:true,sortRestart:true});});